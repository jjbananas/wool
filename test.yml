# Columns
column money:
    type: decimal(10,2)
    default: 0.00

column identity:
    type: int(10)
    increment: true
    unsigned: true
		
column primary:
    type: int(10)
    increment: true
    unsigned: true
    primary: true

column email:
    type: varchar(50)
    
    
cart:
    columns:
        cartId:
            type: primary
            
        shipping:
            type: money
    
    derived:
        subTotal:
            sum: cart_line.net
            
        net:
            fetch: shipping + subTotal
            
        tax:
            sum: cart_line.tax
				
        total:
            fetch: net + tax
            
            
cart_line:
    columns:
        cartLineId:
            type: primary
            
        quantity:
            type: int(10)
            
        cart:
            type: key
            update: cascade
            delete: cascade
						
        product:
            type: key
            update: cascade
            delete: cascade
            
    derived:
        title:
            fetch: product.title
            
        itemPrice:
            fetch: product.price
            
        net:
            fetch: itemPrice * quantity
        
        tax:
            fetch: net * product.tax.rate
            
        total:
            fetch: net + tax
            
            
product:
    columns:
        productId:
            type: primary
            
        price:
            type: money
            history: pre|post|diff
            
        title:
            type: varchar(50)
            history: pre|post
            
        tax:
            type: key
            update: cascade
            delete: cascade
            
    index:
        unique productId_price: [productId, price]
        
tax:
    columns:
        taxId:
            type: primary
            
        rate:
            type: float

            
invoice:
    columns:
        invoiceId:
            type: primary
    
        cart:
            type: key
            update: cascade
            delete: cascade
        
    derived:
        net:
            sum: invoice_line.net
            
        tax:
            sum: invoice_line.tax
				
        total:
            fetch: net + tax

            
invoice_line:
    columns:
        invoiceLineId:
            type: primary
            
        invoice:
            type: key
            update: cascade
            delete: cascade
            
        cart_line:
            type: key
            update: cascade
            delete: cascade
            
        quantity:
            type: int(10)
            
    derived:
        itemPrice:
            fetch: cart_line.itemPrice
            
        net:
            fetch: itemPrice * quantity
        
        tax:
            fetch: quantity * (cart_line.tax / cart_line.quantity)
            
        total:
            fetch: net + tax
